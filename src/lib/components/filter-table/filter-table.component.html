<p-card class="p-p-2 tableContainer" *ngIf="isTableAccessible">
  <header-actions
    (onClickAction)="handleActionClick($event)"
    [actions]="actions"
    [title]="title"
    [dir]="dir"
    [ngClass]="{ hasTableActions: actions.length > 0 }"
  ></header-actions>

  <p-table
    scrollDirection="both"
    [scrollable]="true"
    scrollHeight="800px"
    [rows]="rows"
    [first]="first ? first : 0"
    [filterDelay]="100000"
    [sortField]="sortField"
    [sortOrder]="sortOrder"
    [defaultSortOrder]="sortOrder"
    [value]="data"
    [lazy]="isConnected"
    (onLazyLoad)="isConnected ? loadData($event) : getConnectionError()"
    dataKey="id"
    [selection]="selectedRows"
    (selectionChange)="onSelectionChange($event)"
    [paginator]="hasData"
    [totalRecords]="totalRecords ? totalRecords : 0"
    [rowsPerPageOptions]="rowsPerPageOptions"
    [globalFilterFields]="globalFilterFields"
    [autoLayout]="true"
    [ngClass]="{
      englishStyle: dir === 'ltr',
      arabicStyle: dir === 'rtl'
    }"
    [resizableColumns]="true"
    responsiveLayout="scroll"
    columnResizeMode="expand"
    [lazyLoadOnInit]="false"
    (keyup.enter)="isConnected ? dt._filter() : getConnectionError()"
    #dt
  >
    <ng-template pTemplate="caption">
      <div class="tableHeaders">
        <div class="simpleData" *ngIf="simpleData.length">
          <span *ngFor="let simple of simpleData">
            <label>
              {{ simple.text }}
              <span class="value">
                {{ simple.value }}
              </span>
            </label>
          </span>
        </div>
        <div *ngIf="allowFilter" class="filterActions">
          <button
            pButton
            [label]="dir === 'ltr' ? 'Clear' : 'مسح'"
            class="p-button-outlined p-button-secondary clear"
            (click)="isConnected ? clear(dt) : getConnectionError()"
          ></button>
          <button
            pButton
            [label]="dir === 'ltr' ? 'Filter' : 'بحث'"
            class="p-button-primary filter"
            (click)="isConnected ? dt._filter() : getConnectionError()"
          ></button>
        </div>
      </div>
    </ng-template>
    <ng-template pTemplate="header">
      <tr>
        <th
          pFrozenColumn
          alignFrozen="left"
          style="width: 3rem"
          *ngIf="allowSelection"
          class="headerCell"
        >
          <p-tableHeaderCheckbox></p-tableHeaderCheckbox>
        </th>
        <th
          *ngFor="let col of columns"
          class="headerCell"
          [ngClass]="{ normal_col: !col.control.sortable }"
          [pSortableColumn]="col.control.sortable ? col.control.name : ''"
        >
          {{ col.control.label }}
          <p-sortIcon
            *ngIf="col.control.sortable"
            field="{{ col.control.name }}"
          ></p-sortIcon>
          <!-- <p-checkbox *ngIf="col.type === 'checkbox'" [(ngModel)]="all[col.control.name]" [binary]="true"
            (onChange)="Checkall($event , col.control.name)"></p-checkbox> -->
        </th>
        <th
          pFrozenColumn
          alignFrozen="right"
          *ngIf="tableActions && isTableActionsAccessible"
          style="box-shadow: -4px 0px 4px 0px rgba(53, 52, 52, 0.21)"
          class="headerCell"
        ></th>
      </tr>
      <tr *ngIf="allowFilter">
        <th
          style="width: 3rem"
          *ngIf="allowSelection"
          class="headerCell noBorder"
        ></th>
        <th *ngFor="let col of columns" class="headerCell noBorder">
          <ng-container [ngSwitch]="col.type" *ngIf="col.control.searchable">
            <ng-container *ngSwitchCase="'dropdown'">
              <app-dropdown-filter
                [queryParams]="queryParams"
                [columnConfig]="col"
                [dependValu]="dependValu"
                (onSelect)="onSelectChange($event, dt)"
                [onClear]="onClear"
              >
              </app-dropdown-filter>
            </ng-container>
            <ng-container *ngSwitchCase="'date'">
              <app-date-filter
                [columnConfig]="col"
                (onSelect)="onSelectDateChange($event, dt)"
                [onClear]="onClear"
              ></app-date-filter>
            </ng-container>
            <ng-container *ngSwitchCase="'date_time'">
              <lib-date-time
                [columnConfig]="col"
                (onSelect)="onSelectDateChange($event, dt)"
                [onClear]="onClear"
              >
              </lib-date-time>
            </ng-container>
            <ng-container *ngSwitchCase="'auto_complete'">
              <app-autocomplete-filter
                [columnConfig]="col"
                [dependValu]="dependValu"
                (onSelect)="onSelectChange($event, dt)"
                [onClear]="onClear"
              >
              </app-autocomplete-filter>
            </ng-container>
            <ng-container *ngSwitchCase="'number'">
              <app-number-filter
                [columnConfig]="col"
                [dependValu]="dependValu"
                (onChange)="onInputChange($event, dt)"
                [onClear]="onClear"
                [queryParams]="queryParams"
              >
              </app-number-filter>
            </ng-container>
            <ng-container *ngSwitchDefault>
              <app-input-filter
                [columnConfig]="col"
                (onChange)="onInputChange($event, dt)"
                [onClear]="onClear"
                [queryParams]="queryParams"
              ></app-input-filter>
            </ng-container>
          </ng-container>
        </th>
        <th
          *ngIf="tableActions && isTableActionsAccessible"
          class="headerCell noBorder"
        ></th>
      </tr>
    </ng-template>
    <ng-template pTemplate="body" let-row>
      <tr>
        <td
          pFrozenColumn
          alignFrozen="left"
          [style]="{ width: '5%' }"
          [ngClass]="{ selected: row.selected && applySelectedClass }"
          *ngIf="allowSelection"
          class="tableColumnCell"
        >
          <p-tableCheckbox [value]="row"></p-tableCheckbox>
        </td>
        <td
          [ngClass]="{ selected: row.selected && applySelectedClass }"
          *ngFor="let col of columns"
          class="tableColumnCell"
          pTooltip="{{
            checkLength(col, row[col.control.name])
              ? row[col.control.name]
              : null
          }}"
          tooltipPosition="left"
          tooltipStyleClass="tooltip"
        >
          <ng-container [ngSwitch]="col.type">
            <ng-container *ngSwitchCase="'image'">
              <img [src]="row[col.control.name]" class="imageContainer"
            /></ng-container>
            <ng-container *ngSwitchCase="'date_time'">
              <span>
                {{
                  row[col.control.name]
                    | date : "dd-MM-yyyy, h:mm a" : "+0000" || ""
                }}</span
              ></ng-container
            >
            <div *ngSwitchCase="'date'">
              <ng-container *ngIf="col.control.isDateTime; else normal">
                <span *ngIf="col.control.showString; else showDate">
                  {{ row[col.control.name] }}</span
                >
                <ng-template #showDate>
                  <span>
                    {{
                      row[col.control.name]
                        | date : "dd-MM-yyyy, h:mm a" : "+0000" || ""
                    }}</span
                  >
                </ng-template>
              </ng-container>
              <ng-template #normal>
                <span *ngIf="col.control.showString; else showDate">
                  {{ row[col.control.name] }}</span
                >
                <ng-template #showDate>
                  {{
                    columnControl(col).view
                      ? (row[col.control.name] | date : "MM/yyyy" : "+0000")
                      : (row[col.control.name]
                          | date : "dd/MM/yyyy" : "+0000") || ""
                  }}
                </ng-template>
              </ng-template>
            </div>
            <ng-container *ngSwitchCase="'number'">
              <ng-container *ngIf="col.control.editable; else notEditable">
                <div class="flex flex-row error-container">
                  <input
                    type="text"
                    id="inputtext-left"
                    NumberAndDecimalOnly
                    [allowDecimals]="col?.control?.allowDecimals"
                    [allowSign]="col?.control?.allowSign"
                    [maxlength]="col.control.maxLength"
                    [min]="col?.control?.minValue"
                    pInputText
                    [(ngModel)]="row[col.control.name]"
                  />
                  <div class="flex flex-column">
                    <span
                      class="error"
                      *ngIf="
                        isColumnRequired(col) &&
                        isEmptyString(row[col.control.name])
                      "
                      >This field is required.</span
                    >
                    <span
                      class="error"
                      *ngIf="
                        !isEmptyString(row[col.control.name]) &&
                        hasMinValueError(row, col)
                      "
                      >Minimum value is {{ col?.control?.minValue }}.</span
                    >
                  </div>
                </div>
              </ng-container>
              <ng-template #notEditable>
                <div
                  *ngIf="
                    col.control.name.toLowerCase().includes('id') ||
                      col.control.name.toLowerCase().includes('order') ||
                      col.control.normalNumber;
                    else pipeNumbers
                  "
                >
                  {{ row[col.control.name] }}
                </div>
                <ng-template #pipeNumbers>
                  <div>
                    {{
                      getNumberOfColumn(row[col.control.name])
                        | number : "1.2-2"
                    }}
                  </div>
                </ng-template>
              </ng-template>
            </ng-container>

            <ng-container *ngSwitchCase="'checkbox'">
              <p-checkbox
                *ngIf="col.type === 'checkbox'"
                [checked]="checkIfSelected(row.id, col.control.name)"
                [binary]="true"
                (onChange)="CheckAndAdd($event, row.id, col.control.name, row)"
              ></p-checkbox>
              {{ row[col.control.name] }}
            </ng-container>

            <ng-container *ngSwitchCase="'json'">
              <span [innerHTML]="convertJsonData(row[col.control.name])"></span>
            </ng-container>

            <div *ngSwitchDefault style="line-break: anywhere">
              <ng-container *ngIf="col.control.isStatus; else normal">
                <span
                  class="status-column"
                  [ngClass]="row[col.control.name]?.toLowerCase()"
                >
                  {{ getRowData(row[col?.control?.name]) }}</span
                >
              </ng-container>
              <ng-template #normal>
                <div>
                  {{ getRowData(row[col.control.name]) }}
                </div>
              </ng-template>
            </div>
          </ng-container>
        </td>
        <td
          pFrozenColumn
          alignFrozen="right"
          [ngClass]="{ selected: row.selected && applySelectedClass }"
          *ngIf="tableActions && isTableActionsAccessible"
          class="tableColumnCell"
          style="
            border-left: 1px solid #d5d8e4;
            box-shadow: -4px 0px 4px 0px rgba(53, 52, 52, 0.21);
          "
        >
          <ng-container *ngIf="showActionsAsDropdown; else showNormal">
            <p-dropdown
              class="actionList"
              [options]="tableActions"
              placeholder=""
              [showClear]="false"
              [optionLabel]="'text'"
              appendTo="body"
            >
              <ng-template let-action pTemplate="action">
                <div
                  class="actionsContainer"
                  (click)="clickTableAction(action, row)"
                >
                  <button
                    pButton
                    pRipple
                    type="button"
                    label="Primary"
                    class="p-button-text p-mr-2 p-mb-2"
                    *ngIf="action.isVisible"
                    [ngClass]="action.class"
                    [label]="action.text"
                    [disabled]="action.isDisabled"
                    icon="{{ action.icon }}"
                  ></button>
                </div>
              </ng-template>
            </p-dropdown>
          </ng-container>
          <ng-template #showNormal>
            <div class="action">
              <ng-container *ngFor="let tableAction of tableActions">
                <div
                  [style.visibility]="
                    !(tableAction.isVisible && rowActionCheck(tableAction, row))
                      ? 'hidden'
                      : 'visible'
                  "
                  *ngIf="tableAction.isIcon; else link"
                  (click)="clickTableAction(tableAction, row)"
                  class="tableAction icon p-mr-1 p-mt-1 cursor-pointer"
                  [ngClass]="tableAction.class"
                  [pTooltip]="tableAction.text"
                  tooltipPosition="top"
                  tooltipStyleClass="tooltip"
                >
                  <i [class]="tableAction.icon"></i>
                </div>

                <ng-template #link>
                  <div
                    [style.visibility]="
                      !(
                        tableAction.isVisible &&
                        rowActionCheck(tableAction, row)
                      )
                        ? 'hidden'
                        : 'visible'
                    "
                    (click)="clickTableAction(tableAction, row)"
                    class="tableAction p-mr-1 p-mt-1"
                    [ngClass]="tableAction.class"
                  >
                    <p-button
                      [label]="tableAction.text"
                      [icon]="tableAction.icon"
                      styleClass="p-button-link p-mr-2"
                    ></p-button>
                  </div>
                </ng-template>
              </ng-container>
            </div>
          </ng-template>
        </td>
      </tr>
    </ng-template>
    <ng-template pTemplate="emptymessage">
      <tr>
        <td [colSpan]="getMiddle()">
          <div class="noRecords">
            <i class="pi pi-database noRecords_icon"></i>

            <p class="noRecords_paragraph">No Records Found</p>
          </div>
        </td>
      </tr>
    </ng-template>
  </p-table>
</p-card>
<p-toast position="bottom-center" [preventOpenDuplicates]="true"></p-toast>
